# Общий модуль ПроведениеСерверПТБ

Методы общего модуля **ПроведениеСерверПТБ** унифицированы и не требуют доработок. Данная документация предназначеня для подробного разбора работы некоторых методов модуля.

# Программный интерфейс

## ОбновитьДвиженияДокумента

Выполняет обновление движений по переданному списку регистров. Запись данных регистров выполняется с отключением бизнес-логики и без регистрации в планах обмена. Рекомендуется использовать для изменения движений при обновлениях конфигурации.

| Имя параметра | Тип | Описание |
|-|-|-|
| Объект | ДокументОбъект | Объект, движения которого требуется обновить
| СписокРегистров | Строка, Массив | Список регистров для обновления движений. Если значение не указано, обновляются все записи. По умолчанию не указано.
| Отказ | Булево | Признак для возврата флага отказа от формирования движений. Например если произошла ошибка в процессе обработки. По умолчанию = ЛОЖЬ
| РежимПроведения | РежимПроведенияДокумента | Значение параметра режим проведения, для передачи в инициализацию доп. сведений. По умолчанию не указано.

## ИнициализацияДополнительныхСвойствДляПроведения

Вызывается для первичной инициализаии данных для проведения. Располагается в обработке проведения. Пример см. метод **ОбработкаПроведения** общего модуля **ПроведениеСерверПТБ**.

| Имя параметра | Тип | Описание |
|-|-|-|
| ДокументСсылка | ДокументСсылка | Ссылка на документ, для которого выполняется инициализация параметров
| ДополнительныеСвойства | Структура | См. свойство **ДополнительныеСвойства** объекта.
| РежимПроведения | РежимПроведенияДокумента | Значение параметра режим проведения

**ДополнительныеСвойства** – свойство объекта ДокументОбъект. Структура, которая может хранить некоторые значения, связанные с объектом, без изменения объекта.

Свойство доступно для изменения не только в обработке проведения, но и прочих обработчиках модуля объекта это свойство доступно, пока существует объект. Например, можно в обработчике перед записью поместить в это свойство некоторые данные, а затем воспользоваться ими в обработке проведения.

### Ключи свойств добавляемых инициализацией

| Имя параметра | Тип | Описание |
| --- | --- | --- |
| **ОбщиеДанные** | Структура | Структура с общими данными для проведения. Состав ключей см. ниже
| .МенеджерВременныхТаблиц | МенеджерВременныхТаблиц | менеджер для хранения временных таблиц в процессе выполнения методов
| .Метаданные | ОбъектМетаданных.Документ | Метаданные документа
| .РегистрыДляКонтроля | Массив | Массив регистров для которых требуется контроль
| .РежимПроведения | РежимПроведенияДокумента | Значение соответствующего параметра обработчика события **ПередЗаписью** модуля объекта документа
| .Ссылка | ДокументСсылка | Ссылка на документ, по которому выполняется проведение
| .ТекстыЗапроса | Массив | Набор запросов формирования данных временных таблиц или таблиц движений в порядке выполнения
| **ПараметрыПроведения** | Структура | Структура для хранения таблиц значений с данными для выполнения движений. Ключ - имя таблицы, как оно задано при вызове метода **ПроведениеСерверПТБ.ДобавитьТаблицуЗапроса**. При отмене проведения параметр отсутствует.
| **РассчитыватьИзменения** | Булево | Признак необходимости расчета изменений движений перед записью и при записи в регистрах. Используется при реализации контроля остатков
| **РежимЗаписи** | РежимЗаписиДокумента | Значение соответствующео параметра обработчика события **ПередЗаписью** модуля объекта документа
| **РезультатКонтроля** | Структура | Структура для хранения таблиц, с данными результатов контроля. Используется при формировании сообщений пользователю о результате контроля. См. метод **СообщитьКонтрольРезультатовПроведения**
| **ЭтоНовый** | Булево | Признак, что ссылка на документ еще не создана

>Параметр “ПараметрыПроведения” отсутствует при отмене проведения с контролем

---

## ПодготовитьНаборыЗаписейКРегистрацииДвижений

| Имя параметра | Тип | Описание |
|-|-|-|
| Объект | ДокументОбъект | Объект, движения которого требуется подготовить
| Отказ | Булево | Признак для возврата флага отказа от формирования движений. Например если произошла ошибка в процессе обработки. По умолчанию = ЛОЖЬ

Выполняется проверка на наличие реквизита “РучнаяКорректировка” в документе, и если данный реквизит существует и установлен = Истина, тогда движения не очищаются, а просто отключается их актуальность.

Ручная корректировка - это возможность пользователю вручную сформировать движения документа. Механизм унаследован из типовой конфигурации Бухгалтерия предприятия.

---

## ЗаписатьНаборыЗаписей

| Имя параметра | Тип | Описание |
|-|-|-|
| Объект | ДокументОбъект | Объект, движения которого требуется подготовить

Процедура формирует дополнительные параметры, которые будут доступны в модуле набора записей регистра (подготовка к процедуре контроля), а также выполняет запись движений. Движения записываются в единой последовательности, обеспечивается это тем, что производится запись сразу всей коллекции движений в рамках одной транзакции.

Такой подход к записи движений устраняет возможные взаимоблокировки в информационной базе, так как ресурсы в транзакции имеют одинаковый порядок захвата.

---

## ВыполнитьКонтрольРезультатовПроведения

| Имя параметра | Тип | Описание |
|-|-|-|
| Объект | ДокументОбъект | Объект, движения которого требуется подготовить
| Отказ | Булево | Признак для возврата флага отказа от формирования движений. Например если произошла ошибка в процессе обработки. По умолчанию = ЛОЖЬ

Когда движения записаны, настало время проверки результатов проведения. По каждому из регистров, находящихся в массиве ДополнительныеСвойства.ОбщиеДанные.РегистрыДляКонтроля, будет проведен контроль.

---

## ОчиститьДополнительныеСвойства

| Имя параметра | Тип | Описание |
|-|-|-|
| ДополнительныеСвойства | Структура | См. свойство **ДополнительныеСвойства** объекта.

Используется для закрытия менеджера временных таблиц. Обязателен к вызову по окончанию обработки проведения.

## ПолучитьИспользуемыеРегистры

| Имя параметра | Тип | Описание |
|-|-|-|
| ДокументСсылка | ДокументСсылка | Ссылка на документ, для которого выполняется инициализация параметров
| Движения | КоллекцияДвижений | Коллекция движений документа
| МассивИсключений | Массив | Массив регистров, по которым не требуется проверка движений

Возвращает массив регистров, по которым документ имеет движения. Без учета исключаемых регистров.

## ПутьКТабличнойЧасти

| Имя параметра | Тип | Описание |
|-|-|-|
| ДополнительныеСвойства | Структура | См. свойство **ДополнительныеСвойства** объекта.
| ИмяТаблицыДанных | Строка | Имя таблицы для отбора строк и получения номера строки. Должна находится в коллекции **ПараметрыПроведения**. Проверяет наличие коллекции параметров и наличие таблицы в ней. При отсутствии возвращает значение параметра **ПолноеИмяРеквизита**. Таблица данных должна содержать все колонки указанные в параметре **ОтборСтрок**, а также колонку *НомерСтроки* или *НомерСтрокиТЧ*
| ОтборСтрок | Структура | Данные для отбора строк по таблице данных
| ПолноеИмяРеквизита | Строка | Полный путь к реквизиту, включая *Объект.* (при необходимости), имя табличной части и имя реквизита. Например: Объект.Контрагенты.Контрагент

В результате выполнения функции, если будет найдена указанная таблица, строки в ней, а также будут существовать колонки *НомерСтроки* или *НомерСтрокиТЧ*, будет возвращена строка с полным путем к реквизиту, с учетом номера строки.

# Обработчики событий модуля документа

## ПередЗаписью

| Имя параметра | Тип | Описание |
|-|-|-|
| Объект | ДокументОбъект | Объект, движения которого требуется подготовить
| Отказ | Булево | Признак обработчика ПередЗаписью
| РежимЗаписи | РежимЗаписиДокумента | Признак обработчика ПередЗаписью
| РежимПроведения | РежимПроведенияДокумента | Признак обработчика ПередЗаписью

Устанавливает необходимые параметры дополнительных свойств объекта

## ОбработкаПроведения

| Имя параметра | Тип | Описание |
|-|-|-|
| Объект | ДокументОбъект | Объект, движения которого требуется подготовить
| Отказ | Булево | Признак обработчика ОбработкаПроведения
| РежимПроведения | РежимПроведенияДокумента | Признак ОбработкаПроведения

Выполняет последовательный вызов методов для выполнения проведения. Методы модуля менеджера документа вызываются в следующем порядке:

1. ПодготовитьПараметрыПроведения
2. ВыполнитьДополнительныеПроверки
3. СформироватьДвиженияПоРегистрам
4. СформироватьСписокРегистровДляКонтроля
5. СообщитьКонтрольРезультатовПроведения

## ОбработкаУдаленияПроведения

| Имя параметра | Тип | Описание |
|-|-|-|
| Объект | ДокументОбъект | Объект, движения которого требуется подготовить
| Отказ | Булево | Признак обработчика ОбработкаУдаленияПроведения

При отмене проведения без контроля остатков, вызов методов модуля менеджера объекта документа не выполняется.

## ОбработкаУдаленияПроведенияСКонтролем

| Имя параметра | Тип | Описание |
|-|-|-|
| Объект | ДокументОбъект | Объект, движения которого требуется подготовить
| Отказ | Булево | Признак обработчика ОбработкаУдаленияПроведения

Выполняет последовательный вызов методов для выполнения проведения. Методы модуля менеджера документа вызываются в следующем порядке:

1. СформироватьСписокРегистровДляКонтроля
2. СообщитьКонтрольРезультатовПроведения

Обратите внимание, поскольку отсутствует этап подготовки параметров проведения, свойство **ДополнительныеСвойства.ПараметрыПроведения** не формируется. По данной причине, сообщить пользователю контроль остатков в привязке к строкам документа не выйдет.

Чтобы не определять, выполняется проведение или его отмена, в обработчике сообщения контроля результатов проведения, для указания поля привязки сообщения, рекомендуется использовать метод [ПроведениеСерверПТБ.ПутьКТабличнойЧасти][0]

# Обработчики событий модуля набора записей регистра

## ПередЗаписьюРегистра



## ПриЗаписиРегистра

[0]: ./ПроведениеСерверПТБ.MD#путьктабличнойчасти
