# Быстрая реализация проведения с контролем остатков

Перенести в модуль объекта документа код из [образца][0]. Дополнительных доработок не требуется

---

Перенести в модуль менеджера документа код из [образца][1].

1. ПодготовитьПараметрыПроведения
    - дорабатываем метод ИнициализироватьРеквизитыДокумента
        - изменяем текст запроса (см. переменная ТекстЗапроса)
        - добавляем свои собственные параметры запроса (см. после // Дополнение параметров)
    - добавляем методы получения данных для формирования движений по наборам регистров
        - для формирования временных таблиц см.     ТекстЗапросаТабличныеЧасти
            - не забываем о префиксе “ВТ_” для временных таблиц
            - не забываем что необходимо добавлять все таблицы методом `ПроведениеСерверПТБ.ДобавитьТаблицуЗапроса("ИмяТаблицы", ДополнительныеСвойства);`
        - для формирования движений по регистрам см. ТекстЗапросаРегистрОстатки
            - не забываем свернуть результат запроса для уменьшения количества строк записей регистра
            - не забываем добавить в запрос расчет номера строки ТЧ для вывода сообщений при контроле. Пример: `МИНИМУМ(ТабличнаяЧасть.НомерСтроки) КАК НомерСтрокиТЧ`
2. ВыполнитьДополнительныеПроверки
    - При необходимости прописываем логику дополнительных проверок перед формированием движений
3. СформироватьДвиженияПоРегистрам
    - Добавляем отдельную Экспортную процедуру для формирования движений по каждому регистру. Подробнее см. **СформироватьДвиженияРегистрОстатки**.
    - Для регистров с контролем после записи движений добавляем код `Движения.[ИмяРегистра].Записывать = Истина;`
4. СформироватьСписокРегистровДляКонтроля
    - Добавляем все регистры с контролем после записи движений
    - Не забываем в методе **СформироватьДвиженияПоРегистрам** добавить признак **Записывать**
    - Не забываем реализовать всю необходимую логику в модуле набора записей указанных регистров. См. Модуль набора записей регистра.
5. СообщитьКонтрольРезультатовПроведения
    - Рекомендуется делать после реализации изменений в модуле набора записей регистров.
    - Для каждого из регистров описываем сообщение пользователю об ошибка контроля остатков.
        - Не забываем что результат контроля (из модуля набора записей регистра) в находится в ДополнительныеСвойства.РезультатКонтроля. Ключ = имени регистра как оно задано в конфигураторе
        - Не забываем использовать сообщения пользователям с указанием ссылки, пути к реквизиту и объекта
        - Путь к реквизиту ТЧ рекомендуется формировать с номером строки (см. ПроведениеСерверПТБ.ПутьКТабличнойЧасти)

---

Перенести в модуль набора записей регистра код из [образца][2].

1. ПередЗаписью. Изменений не требуется
2. ПриЗаписи
    - Добавить правила проверки в массив ПравилаПроверки.
        - для ресурсов, которые не должны уменьшаться меньше 0, проверка - “< 0”
        - для ресурсов, которые не должны увеличиваться, проверка - “> 0”
        - подробнее см. описания в основной статье
3. ВыполнитьКонтрольРезультатовПроведения
    - изменить текст запроса получения отрицательных остатков (см. Запрос.Текст)
        - не забываем что можно использовать ВТ [ИмяРегистра]Изменение где есть все измерения и ресурсы по движениям которые не прошли проверку (см. ПриЗаписи - ПравилаПроверки)
        - не забываем уничтожить ВТ [ИмяРегистра]Изменение

[0]: ./Документ.МодульОбъекта.bsl
[1]: ./Документ.МодульМенеджера.bsl
[2]: ./Регистр.МодульНабораЗаписей.bsl